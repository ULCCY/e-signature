<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sedang Memuat Dokumen...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3b82f6; /* Tailwind blue-500 */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="spinner border-8 border-gray-200 h-20 w-20 rounded-full mb-6"></div>
    <div class="text-xl font-semibold text-gray-700">Sedang memuat dokumen...</div>
    <div class="text-sm text-gray-500 mt-2">Mohon tunggu sebentar. Proses ini mungkin memakan waktu beberapa detik.</div>

    <script>
        const fileId = "{{ file_id }}";
        const folderName = "{{ folder }}"; 
        
        // Memulai proses unduhan di sisi server
        fetch(`/start_download/${fileId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Gagal memulai pengunduhan file.");
                }
                console.log("✅ Memulai proses unduhan file...");
                checkReady(); // Lanjutkan polling
            })
            .catch(error => {
                console.error("❌ Gagal fetch start download:", error);
                
                // Mengubah teks yang ditampilkan
                document.querySelector('.text-xl').textContent = "Terjadi Kesalahan.";
                document.querySelector('.text-sm').textContent = "Silakan coba lagi.";
                
                // Menambahkan tombol "Coba Lagi"
                const retryBtn = document.createElement('button');
                retryBtn.textContent = 'Coba Lagi';
                retryBtn.className = 'mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200';
                retryBtn.onclick = () => window.location.reload();
                document.body.appendChild(retryBtn);
            });

        // Polling ke /check_ready/<file_id> tiap 1 detik
        function checkReady() {
            fetch(`/check_ready/${fileId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.ready) {
                        console.log("✅ Dokumen siap, mengalihkan...");
                        window.location.href = `/preview_file/${fileId}?folder=${folderName}`;
                    } else {
                        setTimeout(checkReady, 1000); // Polling lagi setelah 1 detik
                    }
                })
                .catch(error => {
                    console.error("❌ Gagal polling check ready:", error);
                    // Tidak ada tindakan lebih lanjut, karena tombol "Coba Lagi" sudah disediakan di awal
                });
        }
    </script>

</body>
</html>
